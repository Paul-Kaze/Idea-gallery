[FRD]
# FRD: 用户登录与认证模块

## 1. 概述
本项目（Idea Gallery）的登录模块旨在为用户提供快速、安全的认证体验。通过集成 Google OAuth 第三方登录，简化用户注册流程，同时结合 Supabase 云数据库记录用户的属性（如头像、名称）和资产（如积分点数）。

## 2. 功能需求明细

| 一级功能 | 二级功能 | 三级功能 | 需求具体描述 | 优先级 |
|---------|---------|---------|------------|-------|
| 认证管理 | 第三方登录 | Google 登录 | 用户可以在页头（Header）点击 "Sign in" 按钮，通过 Google 账号快速完成认证 | P0 |
| 认证管理 | 第三方登录 | Google 登录 | 首次登录时，系统应自动在 `users` 表中创建记录，保存用户的 email, name 和 avatar_url | P0 |
| 认证管理 | 会话管理 | JWT 会话保持 | 系统使用 JWT 策略维持用户会话，确保用户在刷新页面后保持登录状态 | P0 |
| 认证管理 | 会话管理 | 全局状态同步 | 使用 `next-auth/react` 提供的 `useSession` 劫持全局状态，控制 UI 组件的显隐逻辑 | P0 |
| 认证管理 | 用户退出 | 退出登录 | 用户可在个人下拉菜单中选择 "Sign out"，清除本地会话并更新 UI 为未登录状态 | P0 |
| 账号体系 | 资产同步 | 积分查询 | 登录成功后，系统应自动调用 `/api/user/credits` 获取该用户的实时积分余额并展示在 Header | P1 |
| 账号体系 | 资产同步 | 登录拦截 | 在使用 AI 生成（如 AI 宝宝）或购买积分时，若检测到未登录，需弹出提醒或直接引导至登录流程 | P1 |
| 系统安全 | 防护机制 | 接口限流 | 认证相关的 API 路由需受 Middleware 保护，针对单个 IP 设置每分钟访问频率限制 (Rate Limit) | P1 |

## 3. 错误处理与用户提示
- **ERR-AUTH-001**: 用户取消 Google 授权 -> 系统关闭登录弹窗，保持当前页面状态，不进行报错。
- **ERR-AUTH-002**: 网络原因导致认证失败 -> 弹出 Toast 提示“登录失败，请检查网络连接后重试”。
- **ERR-AUTH-003**: 触发限流 (429) -> 页面提示“操作过于频繁，请稍后再试”。
- **ERR-AUTH-004**: Supabase 数据库连接异常 -> 用户可完成第三方认证，但由于无法同步数据，Header 可能会提示“用户信息同步失败”。

## 4. 数据与交互细节
- **数据字段**:
    - `users.id`: 内部唯一 UUID
    - `users.email`: 账户锚点，不可更改
    - `users.credits`: 默认 0，支持后续充值
- **交互流程**:
    1. 点击 Sign in
    2. 跳转/弹出 Google 授权页
    3. 授权成功，回调至系统
    4. 系统后台检测 email 存在性：若无则 Insert，若有则保持
    5. 前台 UI 变为带头像的下拉菜单样式
[/FRD]
